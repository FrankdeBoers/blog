---
title: H264解析（二）
tags: Android 音视频
categories: Android
---

### 一、H.264相关概念

#### 1、帧
在H.264中，一帧表示一个视频图片编码后的数据，一帧由一个或多个片组成，一个片由一个或多个宏块组成，一个宏块由16x16的yuv数据组成。

![帧-片-宏块](https://raw.githubusercontent.com/FrankdeBoers/blog/master/static/img/%E5%B8%A7-%E7%89%87-%E5%AE%8F%E5%9D%97.png)

#### 2、I、B、P帧
H.264标准中，定义了I帧、B帧、P帧。

*I帧*：帧内编码帧（intra picture）。是完整的一个图像，单独拿出来可以查看。I帧是每个GOP的第一个帧，经过简单地压缩，作为随机访问的参考点。
在Android中，MediaMetadataRetriever.java#getFrameAtTime(0)，会返回一张图片，作为视频的封面、缩略图，在底层的实现中，就是遍历0S之后的数据，
拿到第一个I帧，然后返回这张图片。注：getFrameAtTime(-1)，并不是随机返回一个I帧，而是在视频中寻找，找出最大的（持续时间最长的）有效帧，然后返回它的I帧。

P帧：前向预测编码帧（predictive-frame），表示的是这一帧跟之前的I帧（或者P帧）的差别。解码时需要用之前的I帧，叠加上本帧，生成最终的画面。
所以P帧是差别帧，P帧没有完成的画面数据，单独抽出来是无法查看的。

B帧：双向预测内差编码帧（双向差别帧、双向预测帧）（bi-directional interpolated prediction frame）。也是差异帧，既考虑源视频序列前面的已编码帧，
也考虑视频序列后面已编码帧，来压缩产生B帧。  要解码B帧，不仅要获取之前的缓存画面，也要解码之后的画面，然后叠加本帧数据得到最终的画面。B帧的压缩率高，
但是解码会大量消耗CPU资源。

注：

I帧是完整的视频帧，换句话说，客户端只有在获得I帧后才会有完整的视频。如果直接发送，不等I帧，客户端得到的画面会残缺，但是延迟较低。如果等I帧，客户端缓冲时间较长，得到画面会完整，但是延迟至少是一个GOP。视频通话、播放网络视频时，如果出现花屏现象，一般是由于I帧丢失导致的，可以通过等待I帧后展示画面解决。

#### 3、GOP
Grop Of Picture，两个I帧之间的视频帧，包括1个I帧+多个P帧+多个B帧。GOP：IBBPBBPBBPBBI。  一般是一段时间内变化不大的视频帧集。在一个GOP内I frame解码不依赖任何的其它帧，p frame解码则依赖前面的I frame或P frame，B frame解码依赖前最近的一个I frame或P frame 及其后最近的一个P frame。

